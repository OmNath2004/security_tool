<!-- templates/index.html -->
{% extends "base.html" %}

{% block content %}
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Requirements Dashboard</h2>
        </div>
        <div class="col-md-6 text-end">
            <a href="{{ url_for('add_req') }}" class="btn btn-primary">Add New Requirement</a>
        </div>
    </div>
    
    <!-- Search and Filter -->
    <div class="row mb-3">
        <div class="col-md-4">
            <input type="text" class="form-control" id="searchInput" placeholder="Search requirements..." value="{{ search }}">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                {% for cat in categories %}
                    <option value="{{ cat }}" {% if category_filter == cat %}selected{% endif %}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-5 text-end">
            <button class="btn btn-outline-secondary" onclick="filterRequirements()">Filter</button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Clear</a>
        </div>
    </div>
    
    <!-- Stats -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card text-center bg-danger text-white">
                <div class="card-body">
                    <h5>High</h5>
                    <h2>{{ stats.get('High', 0) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-white">
                <div class="card-body">
                    <h5>Medium</h5>
                    <h2>{{ stats.get('Medium', 0) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h5>Low</h5>
                    <h2>{{ stats.get('Low', 0) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-secondary text-white">
                <div class="card-body">
                    <h5>Total</h5>
                    <h2>{{ stats.values() | sum }}</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Requirements Table -->
    <div class="table-responsive">
        <table class="table table-striped" id="reqTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Category</th>
                    <th>Functional Req</th>
                    <th>Security Req</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if requirements %}
                    {% for req in requirements %}
                        <tr>
                            <td>{{ req[0] }}</td>
                            <td>{{ req[4] or 'Other' }}</td>
                            <td>{{ req[1][:50] }}{% if req[1]|length > 50 %}...{% endif %}</td>
                            <td>{{ req[2][:50] }}{% if req[2]|length > 50 %}...{% endif %}</td>
                            <td><span class="badge bg-{{ 'danger' if req[3]=='High' else 'warning' if req[3]=='Medium' else 'info' }}">{{ req[3] }}</span></td>
                            <td>{{ req[5] }}</td>
                            <td>
                                <a href="{{ url_for('edit_req', req_id=req[0]) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ req[0] }})">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="7" class="text-center">No requirements yet. <a href="{{ url_for('add_req') }}">Add one!</a></td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        function filterRequirements() {
            const search = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            window.location.href = `/?search=${encodeURIComponent(search)}&category=${encodeURIComponent(category)}`;
        }

        function confirmDelete(id) {
            if (confirm('Are you sure?')) {
                window.location.href = `/delete/${id}`;
            }
        }
    </script>
{% endblock %}